<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Настройка двухфакторной аутентификации</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .totp-grid { display: flex; flex-wrap: wrap; gap: 24px; }
        .totp-section { flex: 1 1 320px; min-width: 300px; }
        code { background: #f5f5f5; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Двухфакторная аутентификация (TOTP)</h1>
        <div>
            <a class="btn" href="/profile" style="margin-right:8px;">Вернуться в профиль</a>
            <form method="post" th:action="@{/logout}" style="display:inline;">
                <button class="btn" type="submit">Выйти</button>
            </form>
        </div>
    </header>

    <div th:if="${alreadyEnabled}" class="card">
        <h2>2FA включена</h2>
        <p>Ваш аккаунт защищён кодами приложения (Google Authenticator / Authy и т.д.).</p>
        <p>Если вы хотите отключить 2FA, введите текущий пароль.</p>
        <div class="error-message" th:if="${disableError}" th:text="${disableError}"></div>
        <form method="post" th:action="@{/profile/totp/disable}" style="margin-top:12px;">
            <label>Текущий пароль</label>
            <input class="input" type="password" name="currentPassword" required>
            <button class="btn" type="submit" style="margin-top:10px;">Отключить 2FA</button>
        </form>
    </div>

    <div th:if="${!alreadyEnabled}" class="card">
        <h2>Включение 2FA</h2>
        <p>Шаги:</p>
        <ol>
            <li>Откройте приложение-аутентификатор (Google Authenticator, 1Password, Authy и пр.).</li>
            <li>Отсканируйте QR-код или добавьте учётную запись вручную, используя секрет.</li>
            <li>Введите текущий 6-значный код подтверждения ниже.</li>
        </ol>
        <div class="totp-grid">
            <div class="totp-section">
                <h3>QR-код</h3>
                <img src="/profile/totp/qr" alt="QR для TOTP" style="border:1px solid #ddd; width:256px; height:256px;">
            </div>
            <div class="totp-section">
                <h3>Секрет</h3>
                <p><code th:text="${secret}">SECRET_PLACEHOLDER</code></p>
                <p style="font-size:0.9em;color:#555;">Храните секрет в тайне. Если потеряете доступ к устройству, 2FA придётся отключать через поддержку.</p>
                <h3 style="margin-top:20px;">Подтверждение</h3>
                <div class="error-message" th:if="${error}" th:text="${error}"></div>
                <form method="post" th:action="@{/profile/totp/enable}" style="margin-top:8px;">
                    <label>6-значный код из приложения</label>
                    <input class="input" type="text" name="code" pattern="\d{6}" placeholder="123456" required>
                    <button class="btn" type="submit" style="margin-top:10px;">Включить 2FA</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:24px;">
        <h2>Отладочная информация</h2>
        <p>alreadyEnabled: <code th:text="${alreadyEnabled}">false</code></p>
        <p th:if="${secret}">secret: <code th:text="${secret}">---</code></p>
    </div>
</div>
</body>
</html>

